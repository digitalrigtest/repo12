-- PROCEDURE: api.jira_metric()

-- DROP PROCEDURE api.jira_metric();

CREATE OR REPLACE PROCEDURE api.jira_metric(
	)
LANGUAGE 'plpgsql'
AS $BODY$
begin

	DELETE FROM api.jira_raw_rig_sprint;

    INSERT INTO api.jira_raw_rig_sprint
        (
        lob ,
        application_name,
		team_name,
		riglet_name,
        project_key,
        sprint ,
        sprint_completion_date ,
        lead_time
        )
		
    SELECT a.lob,a.application_name,a.team_name,a.riglet_name,a.project_key, a.sprint, a.sprint_completion_date::DATE ,
        coalesce((select trunc(sum(extract(day from (done::timestamp - created_date::timestamp)))/count(distinct(issue_id))) 
				  from api.jira_raw_rig d
		where d.application_name = a.application_name
		and d.team_name = a.team_name
		and d.riglet_name = a.riglet_name
		and d.sprint = a.sprint
		and d.status = 'Done'
		and d.issue_type = 'Story'),0) lead_time		
		
FROM api.jira_raw_rig a
GROUP by lob ,application_name ,team_name,riglet_name, project_key,sprint ,sprint_completion_date, issue_type,done
HAVING sprint_completion_date <> '' and issue_type = 'Story' and sprint_completion_date is not null
ORDER by lob ,application_name ,team_name, riglet_name desc;
		
end;
$BODY$;
